---
title: "Trachoma Summaries"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
set.seed(200)
library(knitr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(patchwork)

setwd("~/Documents/trachoma-endgame")
load("sampled_params_all.Rdata")
load("Maps/trachoma_espen_data.Rdata")
load("Maps/trachoma_data.Rdata")

#### numerical summaries of failed surveys
sampled_params_all_mutated = sampled_params_all %>%
  mutate(beta1996 = beta_init,
         beta2000 = beta_init*beta75,
         beta2010 = beta_init*beta75*beta85,
         beta2020 = beta_init*beta75*beta85*beta95) %>%
  mutate(reduction2000 = (beta2000-beta1996)/beta1996,
         reduction2010 = (beta2010-beta1996)/beta1996,
         reduction2020 = (beta2020-beta1996)/beta1996) 

#first maps
first_map = trachoma_data %>%
  arrange(IU_ID,Year) %>%
  group_by(IU_ID) %>%
  mutate(IU_ID = as.character(IU_ID)) %>%
  mutate(max_survey_n_clean = ifelse(is.na(max_survey_n),-1,max_survey_n),) %>%
  mutate(new_data = (!(max_survey_n_clean == lag(max_survey_n_clean))) | (Year==1996 & max_survey_n==0)) %>%
  filter(new_data == TRUE) %>%
  summarise(first_data_point = min(Year)) 


#num MDA rounds
num_mda_rounds = trachoma_data %>%
  mutate(IU_ID = as.character(IU_ID)) %>%
  group_by(IU_ID) %>%
  filter(PC_in_group > 0) %>%
  tally()

sampled_params_all_summary = sampled_params_all_mutated %>%
  group_by(IU_ID) %>%
  summarise(median_beta1996 = median(beta1996),
            median_beta2000 = median(beta2000),
            median_beta2010 = median(beta2010),
            median_beta2020 = median(beta2020),
            median_reduction2000 = median(reduction2000),
            median_reduction2010 = median(reduction2010),
            median_reduction2020 = median(reduction2020),
            median_eff_cov = median(eff_cov),
            lwrquant_beta1996 = quantile(beta1996,probs=0.025),
            lwrquant_beta2000 = quantile(beta2000,probs=0.025),
            lwrquant_beta2010 = quantile(beta2010,probs=0.025),
            lwrquant_beta2020 = quantile(beta2020,probs=0.025),
            lwrquant_reduction2000 = quantile(reduction2000,probs=0.025),
            lwrquant_reduction2010 = quantile(reduction2010,probs=0.025),
            lwrquant_reduction2020 = quantile(reduction2020,probs=0.025),
            lwrquant_eff_cov = quantile(eff_cov,probs=0.025),
            uprquant_beta1996 = quantile(beta1996,probs=0.975),
            uprquant_beta2000 = quantile(beta2000,probs=0.975),
            uprquant_beta2010 = quantile(beta2010,probs=0.975),
            uprquant_beta2020 = quantile(beta2020,probs=0.975),
            uprquant_reduction2000 = quantile(reduction2000,probs=0.975),
            uprquant_reduction2010 = quantile(reduction2010,probs=0.975),
            uprquant_reduction2020 = quantile(reduction2020,probs=0.975),
            uprquant_eff_cov = quantile(eff_cov,probs=0.975)) %>%  
  ungroup() %>%
  left_join(first_map) %>%
  left_join(num_mda_rounds) %>%
  mutate(mda_rounds = ifelse(is.na(n),0,n),
            median_beta2000 = ifelse(first_data_point >2000, NA, median_beta2000),
            median_beta2010 = ifelse(first_data_point >2010, NA, median_beta2010),
            median_beta2020 = ifelse(first_data_point >2020, NA, median_beta2020),
            median_reduction2000 = ifelse(first_data_point >2000, NA, median_reduction2000),
            median_reduction2010 = ifelse(first_data_point >2010, NA, median_reduction2010),
            median_reduction2020 = ifelse(first_data_point >2020, NA, median_reduction2020),
            lwrquant_beta2000 = ifelse(first_data_point >2000, NA, lwrquant_beta2000),
            lwrquant_beta2010 = ifelse(first_data_point >2010, NA, lwrquant_beta2010),
            lwrquant_beta2020 = ifelse(first_data_point >2020, NA, lwrquant_beta2020),
            lwrquant_reduction2000 = ifelse(first_data_point >2000, NA, lwrquant_reduction2000),
            lwrquant_reduction2010 = ifelse(first_data_point >2010, NA, lwrquant_reduction2010),
            lwrquant_reduction2020 = ifelse(first_data_point >2020, NA, lwrquant_reduction2020),
            uprquant_beta2000 = ifelse(first_data_point >2000, NA, uprquant_beta2000),
            uprquant_beta2010 = ifelse(first_data_point >2010, NA, uprquant_beta2010),
            uprquant_beta2020 = ifelse(first_data_point >2020, NA, uprquant_beta2020),
            uprquant_reduction2000 = ifelse(first_data_point >2000, NA, uprquant_reduction2000),
            uprquant_reduction2010 = ifelse(first_data_point >2010, NA, uprquant_reduction2010),
            uprquant_reduction2020 = ifelse(first_data_point >2020, NA, uprquant_reduction2020))

# can replace this when redoing trachoma
surveys = trachoma_espen_data %>%
  group_by(IU_ID) %>%
  mutate(survey_n_clean = ifelse(is.na(survey_n),-1,survey_n)) %>%
  mutate(survey_change = ifelse((survey_n_clean == lag(survey_n_clean) & !(type_prevalence == lag(type_prevalence))),1,0)) %>%
  mutate(survey_change = ifelse(is.na(survey_change),0,survey_change)) %>%
  mutate(type_prevalence_least = case_when(
    type_prevalence == "baseline" ~ 0,
    type_prevalence == "impact" ~ 1,
    type_prevalence == "surveillance" ~ 2
  )) %>% 
  ungroup() %>%
  group_by(IU_ID, Year, ADMIN0ISO2) %>%
  summarise(max_tf_prev_upr = ifelse(length(which(!is.na(tf_prev_upr)))>0,max(tf_prev_upr, na.rm=T),NA),
            max_survey_n = ifelse(length(which(!is.na(tf_prev_upr)))>0,max(survey_n, na.rm=T),NA),
            max_survey_change = ifelse(length(which(!is.na(tf_prev_upr)))>0,max(survey_change, na.rm=T),NA),
            PC_in_group = max(PC),
            min_type_prevalence_least = min(type_prevalence_least)) %>%
  ungroup() %>% 
  arrange(IU_ID,Year) %>%
  group_by(IU_ID) %>%
  mutate(max_survey_n_clean = ifelse(is.na(max_survey_n),-1,max_survey_n)) %>%
  mutate(new_data = (!(max_survey_n_clean == lag(max_survey_n_clean))) | (Year==1996 & max_survey_n==0) | max_survey_change == 1) %>%
  filter(new_data == TRUE)


# impact survey failures
#ius_that_failed_impact_surveys = trachoma_espen_data %>%
#  filter(type_prevalence %in% c("impact") & !tf_prev_upr == 0.05)
ius_that_failed_impact_surveys = surveys %>%
  filter(min_type_prevalence_least == 1 & !max_tf_prev_upr == 0.05)

sampled_params_failed_impact_summary= sampled_params_all_summary %>%
  filter(IU_ID %in% ius_that_failed_impact_surveys$IU_ID) %>%
  group_by(IU_ID) 

# surveillance survey failures
#ius_that_failed_surveillance_surveys = trachoma_espen_data %>%
#  filter(type_prevalence %in% c("surveillance") & !tf_prev_upr == 0.05)
ius_that_failed_surveillance_surveys = surveys %>%
  filter(min_type_prevalence_least == 2 & !max_tf_prev_upr == 0.05)

sampled_params_failed_surveillance_summary = sampled_params_all_summary %>%
  filter(IU_ID %in% ius_that_failed_surveillance_surveys$IU_ID) %>%
  group_by(IU_ID) 

# passed surveys
sampled_params_passed_summary= sampled_params_all_summary %>%
  filter(!IU_ID %in% c(ius_that_failed_impact_surveys$IU_ID,ius_that_failed_surveillance_surveys$IU_ID)) %>%
  group_by(IU_ID) 

# rebounds
sampled_params_rebounds_summary = sampled_params_all_summary %>%
  filter(IU_ID %in% ius_that_failed_surveillance_surveys$IU_ID & (!IU_ID %in% ius_that_failed_impact_surveys$IU_ID))

# persistance 
# ius_persistent = trachoma_espen_data %>%
#   group_by(IU_ID,Geoconnect_ID) %>%
#   summarise(min_tf = ifelse(length(which(!is.na(tf_prev_upr)))>0,min(tf_prev_upr, na.rm=T),NA),
#             num_impacts_failed = length(which(type_prevalence=="impact" & tf_prev_upr > 0.05))) %>%
#   ungroup() %>%
#   filter(min_tf > 0.05 & num_impacts_failed >= 2) 
ius_persistent = surveys %>%
  group_by(IU_ID) %>%
  summarise(min_tf = min(max_tf_prev_upr),
            num_impacts_failed =  length(which(min_type_prevalence_least==1 & max_tf_prev_upr > 0.05))) %>%
  ungroup() %>%
  filter(min_tf > 0.05 & num_impacts_failed >= 2)

# persistent
sampled_params_persistent_summary = sampled_params_all_summary %>%
  filter(IU_ID %in% ius_persistent$IU_ID)

# baseline + latest prev (ESPEN)
baseline_tf = surveys %>%
  group_by(IU_ID,ADMIN0ISO2) %>%
  filter(min_type_prevalence_least == 0) %>%
  summarise(baseline_tf_max = factor(max(max_tf_prev_upr), levels=c("0.05",  "0.099", "0.299", "0.499", "1"))) %>%
  mutate(IU_ID = as.character(IU_ID),
         ADMIN0ISO2 = factor(ADMIN0ISO2, levels=unique(surveys$ADMIN0ISO2)))

last_year = surveys %>%
  group_by(IU_ID,ADMIN0ISO2) %>%
  summarise(last_year = max(Year))

latest_tf = surveys %>%
  left_join(last_year) %>%
  filter(Year==last_year) %>%
  group_by(IU_ID,ADMIN0ISO2) %>%
  mutate(last_max_tf_prev_upr = factor(max_tf_prev_upr, levels=c("0.05",  "0.099", "0.299", "0.499", "1")),
         IU_ID = as.character(IU_ID),
         ADMIN0ISO2 = factor(ADMIN0ISO2, levels=unique(surveys$ADMIN0ISO2)), 
         last_year=factor(last_year)) %>%
  select(IU_ID,last_year,ADMIN0ISO2,last_max_tf_prev_upr)

# add flags
summary_with_flags = sampled_params_all_summary %>%
  mutate(failed_impact_flag = ifelse(IU_ID %in% sampled_params_failed_impact_summary$IU_ID,1,0),
         persistent_flag = ifelse(IU_ID %in% sampled_params_persistent_summary$IU_ID,1,0),
         failed_surveillance_flag = ifelse(IU_ID %in% sampled_params_failed_surveillance_summary$IU_ID,1,0),
         rebound_flag = ifelse(IU_ID %in% sampled_params_rebounds_summary$IU_ID,1,0),
         median_beta1996_binned = cut(median_beta1996,breaks=20,ordered_result=T)) %>%
  left_join(baseline_tf) %>%
  left_join(latest_tf) %>%
  mutate(min_tf = factor(baseline_tf_max, levels=unique(baseline_tf$baseline_tf_max)),
         mda_rounds_binned = factor(case_when(
           mda_rounds <= 5 ~ "<=5",
           mda_rounds > 5 & mda_rounds <=10 ~ "6-10",
           mda_rounds > 10 ~ "11+",
         ), levels=c("<=5", "6-10", "11+")),
         median_eff_cov_binned = factor(case_when(
           median_eff_cov <= 0.7 ~ "<=0.7",
           median_eff_cov > 0.7 & median_eff_cov <= 0.8 ~ "0.7-0.8",
           median_eff_cov > 0.8 ~ "0.8+"
         ), levels=c("<=0.7","0.7-0.8","0.8+")))

library(randomcoloR)
palette <- distinctColorPalette(length(unique(baseline_tf$ADMIN0ISO2)))

```

Passed surveys refer to those IUs that didn't fail any impact or surveillance surveys. 

4 categories of "problem" IUs considered throughout (not mutually exclusive):

- Failed impact surveys: failed at least 1 impact survey (TF > 5%)
- Persistent: failed at least 2 impact, never below 5% TF
- Failed surveillance surveys: failed at least 1 surveillance survey (TF > 5%)
- Rebound: passed impact survey but failed surveillance survey


# Summarise by category

For each IU, the median, 2.5% and 97.5% quantiles were calculated. These quantiles were then averaged across all IUs in the respective categories.

### Passed surveys

```{r}

# print summaries
passed_ius_summary = data.frame(
  c("beta1996","beta2000","beta2010","beta2020","betareduction2000","betareduction2010","betareduction2020","eff_cov","mda_rounds"),
  rbind(matrix(apply(sampled_params_passed_summary[,-c(1,(ncol(sampled_params_passed_summary)-0:2))],2,function(x) mean(x,na.rm=T)),ncol=3),
  c(quantile(sampled_params_passed_summary$mda_rounds,probs=c(0.5,0.025,0.975)))))
colnames(passed_ius_summary) = c("variable","mean_of_q0.5","mean_of_q0.025","mean_of_q0.975")
kable(passed_ius_summary)

```

### Failed impact surveys

```{r}
failed_impact_summary = data.frame(
  c("beta1996","beta2000","beta2010","beta2020","betareduction2000","betareduction2010","betareduction2020","eff_cov","mda_rounds"),
  rbind(matrix(apply(sampled_params_failed_impact_summary[,-c(1,(ncol(sampled_params_failed_impact_summary)-0:2))],2,function(x) mean(x,na.rm=T)),ncol=3),
  c(quantile(sampled_params_failed_impact_summary$mda_rounds,probs=c(0.5,0.025,0.975)))))
colnames(failed_impact_summary) = c("variable","mean_of_q0.5","mean_of_q0.025","mean_of_q0.975")
kable(failed_impact_summary)

```

### Persistent (failed at least 2 impact, never below 5% TF)

```{r}
persistent_summary = data.frame(
  c("beta1996","beta2000","beta2010","beta2020","betareduction2000","betareduction2010","betareduction2020","eff_cov","mda_rounds"),
  rbind(matrix(apply(sampled_params_persistent_summary[,-c(1,(ncol(sampled_params_persistent_summary)-0:2))],2,function(x) mean(x,na.rm=T)),ncol=3),
  c(quantile(sampled_params_persistent_summary$mda_rounds,probs=c(0.5,0.025,0.975)))))
colnames(persistent_summary) = c("variable","mean_of_q0.5","mean_of_q0.025","mean_of_q0.975")
kable(persistent_summary)
```



### Failed surveillance surveys
```{r}
failed_surveillance_summary = data.frame(
  c("beta1996","beta2000","beta2010","beta2020","betareduction2000","betareduction2010","betareduction2020","eff_cov","mda_rounds"),
  rbind(matrix(apply(sampled_params_failed_surveillance_summary[,-c(1,(ncol(sampled_params_failed_surveillance_summary)-0:2))],2,function(x) mean(x,na.rm=T)),ncol=3),
  c(quantile(sampled_params_failed_surveillance_summary$mda_rounds,probs=c(0.5,0.025,0.975)))))
colnames(failed_surveillance_summary) = c("variable","mean_of_q0.5","mean_of_q0.025","mean_of_q0.975")
kable(failed_surveillance_summary)
```



### Rebounds (passed impact, failed surveillance)
```{r}
rebounds_summary = data.frame(
  c("beta1996","beta2000","beta2010","beta2020","betareduction2000","betareduction2010","betareduction2020","eff_cov","mda_rounds"),
  rbind(matrix(apply(sampled_params_rebounds_summary[,-c(1,(ncol(sampled_params_rebounds_summary)-0:2))],2,function(x) mean(x,na.rm=T)),ncol=3),
  c(quantile(sampled_params_rebounds_summary$mda_rounds,probs=c(0.5,0.025,0.975)))))
colnames(rebounds_summary) = c("variable","mean_of_q0.5","mean_of_q0.025","mean_of_q0.975")
kable(rebounds_summary)
```

### Comparison plots

- Plots of the intervals presented in the above tables
- Failed impact surveys (including persistent IUs) have higher median beta on average. Not so much for failed surveillance surveys (including rebound IUs)
- MDA rounds of rebounded IUs (passed impact but failed surveillance) smaller than other "problem" categories

```{r, out.width="100%"}
summaries_combined = rbind(cbind(group = "1:Passed",passed_ius_summary),
                           cbind(group = "2:Failed imp.",failed_impact_summary),
                           cbind(group = "3:Persistent.",persistent_summary),
                           cbind(group = "4:Failed surv.",failed_surveillance_summary),
                           cbind(group = "5:Rebounds",rebounds_summary))

ggplot(summaries_combined) +
  geom_point(aes(x=group,y=mean_of_q0.5)) +
  geom_segment(aes(x=group,y=mean_of_q0.025,yend=mean_of_q0.975))+
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  facet_wrap(~variable,ncol=3,scales="free_y")
```

# Summaries by baseline TF prevalence

### Baseline TF vs baseline $\beta$

- Bimodality in the beta distribution for IUs with higher baseline prevalence seems to driven by country
- Medians of effective coverage quite tight around the mean of the prior distribution for IUs that passed all surveys, but not the case for some of the "problem" categories, particularly at higher prevalence

```{r,message=FALSE,warning=FALSE, out.width="100%",fig.height=25}

countries_group_lookup = summary_with_flags %>%
  filter(baseline_tf_max == 0.499) %>%
  group_by(ADMIN0ISO2) %>%
  summarise(average = mean(median_beta1996)) %>%
  arrange(average) %>%
  mutate(group = factor(ifelse(average<0.16,1,2)))


passed_summary_with_flags = summary_with_flags %>% 
  filter((!is.na(baseline_tf_max)) & rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0 & !is.na(ADMIN0ISO2)) %>%
  #mutate(group=ifelse(median_beta1996<0.21,1,2))
  left_join(countries_group_lookup) %>%
  mutate(median_reduction2020_binned = ifelse(median_reduction2020>-0.375,"Small reduction","Large reduction"))

p1=ggplot(data=passed_summary_with_flags) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Passed")
  #guides(fill=guide_colorbar(title="Passed"))

p2=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_impact_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed impact") +
  theme(legend.position = "none")
  #guides(fill=guide_colorbar(title="Failed impact")) 

p3=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & persistent_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Persistent") +
  theme(legend.position = "none")
  #guides(fill=guide_colorbar(title="Persistent")) 


p4=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_surveillance_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed surveillance")+
  theme(legend.position = "none")
  #guides(fill=guide_colorbar(title="Failed surveillance"))


p5=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Rebound") +
  theme(legend.position = "none")
  #guides(fill=guide_colorbar(title="Rebound"))

plot_all = p1 + p2 +p3 + p4 + p5 
plot_all + plot_layout(guides = "collect",ncol=1)

```


### Look at bimodality in passed IUs 

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=12}

p1=ggplot(data=passed_summary_with_flags %>% filter(group==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=median_eff_cov_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Low baseline beta by country (median)")

p2=ggplot(data=passed_summary_with_flags %>% filter(group==2)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta1996, col=ADMIN0ISO2, shape=median_eff_cov_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("High baseline beta by country (median)")

plot_all = p1 + p2
plot_all + plot_layout(guides = "collect",ncol=1)

```

### Look at Ethiopia

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=20}

iu_id_lookup = read.csv("Maps/table_iu_idx_trachoma.csv") %>%
  filter(country=="ETH") %>%
  select(IU_ID,TaskID) %>%
  mutate_if(is.numeric,as.character) 

eth = passed_summary_with_flags %>%
  filter(ADMIN0ISO2=="ET") %>%
  mutate(eth_group = factor(ifelse(median_beta1996 < 0.2,"Low baseline beta","High baseline beta"))) %>%
  left_join(iu_id_lookup)

print("Colour by baseline prevalence")


p1 = ggplot(data=eth) +
  geom_jitter(aes(mda_rounds,median_eff_cov, col=baseline_tf_max,shape=eth_group), width = 0.2, height = 0, alpha = 0.5)+
  ggtitle("MDA rounds vs eff. cov.")

p2 = ggplot(data=eth) +
  geom_jitter(aes(median_beta1996,mda_rounds, col=baseline_tf_max,shape=eth_group), width = 0, height = 0.2, alpha = 0.5)+
  ggtitle("Baseline beta vs MDA rounds")

p3 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_eff_cov, col=baseline_tf_max,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs median eff. cov.")

p4 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_reduction2020, col=baseline_tf_max,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs reduction by 2020")

plot_all = p1 + p2 + p3 + p4
plot_all + plot_layout(guides = "collect",ncol=1)


```

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=20}

print("Colour by latest prevalence")


p1 = ggplot(data=eth) +
  geom_jitter(aes(mda_rounds,median_eff_cov, col=last_max_tf_prev_upr,shape=eth_group), width = 0.2, height = 0, alpha = 0.5)+
  ggtitle("MDA rounds vs eff. cov.")

p2 = ggplot(data=eth) +
  geom_jitter(aes(median_beta1996,mda_rounds, col=last_max_tf_prev_upr,shape=eth_group), width = 0, height = 0.2, alpha = 0.5)+
  ggtitle("Baseline beta vs MDA rounds")

p3 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_eff_cov, col=last_max_tf_prev_upr,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs median eff. cov.")

p4 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_reduction2020, col=last_max_tf_prev_upr,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs reduction by 2020")

plot_all = p1 + p2 + p3 + p4
plot_all + plot_layout(guides = "collect",ncol=1)

```

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=20}

print("Colour by batch ID")

p1 = ggplot(data=eth) +
  geom_jitter(aes(mda_rounds,median_eff_cov, col=TaskID,shape=eth_group), width = 0.2, height = 0, alpha = 0.5)+
  ggtitle("MDA rounds vs eff. cov.")

p2 = ggplot(data=eth) +
  geom_jitter(aes(median_beta1996,mda_rounds, col=TaskID,shape=eth_group), width = 0, height = 0.2, alpha = 0.5)+
  ggtitle("Baseline beta vs MDA rounds")

p3 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_eff_cov, col=TaskID,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs median eff. cov.")

p4 = ggplot(data=eth) +
  geom_point(aes(median_beta1996,median_reduction2020, col=TaskID,shape=eth_group), alpha = 0.5)+
  ggtitle("Baseline beta vs reduction by 2020")

plot_all = p1 + p2 + p3 + p4
plot_all + plot_layout(guides = "collect",ncol=1)


```


### Baseline TF vs $\beta$ in 2020


```{r,message=FALSE,warning=FALSE, out.width="100%",fig.height=30}
p1=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Passed")

p2=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_impact_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed impact") +
  theme(legend.position = "none")

p3=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & persistent_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Persistent") +
  theme(legend.position = "none")


p4=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_surveillance_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed surveillance") +
  theme(legend.position = "none")


p5=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_beta2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,0.6)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Rebound") +
  theme(legend.position = "none")

plot_all = p1 + p2 +p3 + p4 + p5 
plot_all + plot_layout(guides = "collect",ncol=1)
```


### Baseline TF vs overall $\beta$ reduction

```{r,message=FALSE,warning=FALSE, out.width="100%",fig.height=25}
p1=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_reduction2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(-1,0)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Passed")

p2=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_impact_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_reduction2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(-1,0)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed impact") +
  theme(legend.position = "none")

p3=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & persistent_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_reduction2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(-1,0)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Persistent") +
  theme(legend.position = "none")


p4=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_surveillance_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_reduction2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(-1,0)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed surveillance") +
  theme(legend.position = "none")


p5=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_reduction2020, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(-1,0)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Rebound") +
  theme(legend.position = "none")

plot_all = p1 + p2 +p3 + p4 + p5 
plot_all + plot_layout(guides = "collect",ncol=1)
```


### Baseline TF vs effective coverage

```{r,message=FALSE,warning=FALSE, out.width="100%",fig.height=25}
p1=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_eff_cov, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,1)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Passed")

p2=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_impact_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_eff_cov, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,1)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed impact") +
  theme(legend.position = "none")

p3=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & persistent_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_eff_cov, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,1)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Persistent") +
  theme(legend.position = "none")


p4=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_surveillance_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_eff_cov, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,1)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed surveillance") +
  theme(legend.position = "none")


p5=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=median_eff_cov, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,1)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Rebound") +
  theme(legend.position = "none")

plot_all = p1 + p2 +p3 + p4 + p5 
plot_all + plot_layout(guides = "collect",ncol=1)
```


### Baseline TF vs number of MDA rounds

```{r,message=FALSE,warning=FALSE, out.width="100%",fig.height=25}
p1=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0)) +
  geom_jitter(aes(x=baseline_tf_max,y=mda_rounds, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,17)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Passed")

p2=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_impact_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=mda_rounds, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,17)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed impact") +
  theme(legend.position = "none")

p3=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & persistent_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=mda_rounds, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,17)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Persistent") +
  theme(legend.position = "none")


p4=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & failed_surveillance_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=mda_rounds, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,17)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Failed surveillance") +
  theme(legend.position = "none")


p5=ggplot(data=summary_with_flags %>% filter((!is.na(baseline_tf_max)) & rebound_flag==1)) +
  geom_jitter(aes(x=baseline_tf_max,y=mda_rounds, col=ADMIN0ISO2, shape=mda_rounds_binned), stroke=0, size=1.5, width = 0.4, height = 0) +
  #xlim(c(0,0.6)) +
  ylim(c(0,17)) +
  scale_colour_discrete(drop=F) +
  scale_colour_manual(values=palette, drop=F) +
  scale_x_discrete(drop = F) +
  ggtitle("Rebound") +
  theme(legend.position = "none")

plot_all = p1 + p2 +p3 + p4 + p5 
plot_all + plot_layout(guides = "collect",ncol=1)
```


<!-- # Histograms of median baseline $\beta$ by category -->

```{r, out.width="100%"}

# proportion in bin
flag_summary_in_bin_beta1996 = summary_with_flags %>%
  group_by(median_beta1996_binned) %>%
  summarise(failed_impact_prop_in_bin = sum(failed_impact_flag)/n(),
            persistent_prop_in_bin = sum(persistent_flag)/n(),
            failed_surveillance_prop_in_bin = sum(failed_surveillance_flag)/n(),
            rebound_prop_in_bin = sum(rebound_flag)/n()) %>%
  reshape2::melt(id.vars="median_beta1996_binned", variable.name = "flag", value.name = "prop_in_bin")

# ggplot(data=flag_summary_in_bin_beta1996) +
#   geom_bar(aes(x=median_beta1996_binned,y=prop_in_bin),stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
#   facet_wrap(~flag) +
#   ggtitle("Prop. of observations in bin with flag=1")

# proportion overall
flag_summary_overall_beta1996 = summary_with_flags %>%
  group_by(median_beta1996_binned) %>%
  summarise(failed_impact_prop_overall = sum(failed_impact_flag)/nrow(summary_with_flags),
            persistent_prop_overall = sum(persistent_flag)/nrow(summary_with_flags),
            failed_surveillance_prop_overall = sum(failed_surveillance_flag)/nrow(summary_with_flags),
            rebound_prop_overall = sum(rebound_flag)/nrow(summary_with_flags)) %>%
  reshape2::melt(id.vars="median_beta1996_binned", variable.name = "flag", value.name = "prop_overall")

# ggplot(data=flag_summary_overall_beta1996) +
#   geom_bar(aes(x=median_beta1996_binned,y=prop_overall),stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
#   facet_wrap(~flag) +
#   ggtitle("Prop. of total observations with flag=1")
```

<!-- ### Failed impact -->

```{r,message=FALSE,warning=FALSE, out.width="100%"}
# raw counts
p1=ggplot(data=summary_with_flags %>% filter(failed_impact_flag==1)) +
  geom_histogram(aes(x=median_beta1996)) +
  xlim(c(0,0.6)) +
  ggtitle("Failed impact")
p2=ggplot(data=summary_with_flags %>% filter(failed_impact_flag==0)) +
  geom_histogram(aes(x=median_beta1996)) +
  xlim(c(0,0.6)) +
  ggtitle("Didn't fail impact")
#grid.arrange(p1,p2,nrow=1)
```

<!-- ### Persistent -->

```{r,message=FALSE,warning=FALSE, out.width="100%"}
# raw counts
p1=ggplot(data=summary_with_flags %>% filter(persistent_flag==1)) +
  geom_histogram(aes(x=median_beta1996))+
  xlim(c(0,0.6)) + 
  ggtitle("Persistent")
p2=ggplot(data=summary_with_flags %>% filter(persistent_flag==0)) +
  geom_histogram(aes(x=median_beta1996)) +
  xlim(c(0,0.6)) +
  ggtitle("Not persistent")
#grid.arrange(p1,p2,nrow=1)
```

<!-- ### Failed surveillance -->

```{r,message=FALSE,warning=FALSE, out.width="100%"}
# raw counts
p1=ggplot(data=summary_with_flags %>% filter(failed_surveillance_flag==1)) +
  geom_histogram(aes(x=median_beta1996))+
  xlim(c(0,0.6)) +
  ggtitle("Failed surveillance")
p2=ggplot(data=summary_with_flags %>% filter(failed_surveillance_flag==0)) +
  geom_histogram(aes(x=median_beta1996)) +
  xlim(c(0,0.6)) +
  ggtitle("Didn't fail surveillance")
#grid.arrange(p1,p2,nrow=1)
```

<!-- ### Rebounds -->

```{r,message=FALSE,warning=FALSE, out.width="100%"}
# raw counts
p1=ggplot(data=summary_with_flags %>% filter(rebound_flag==1)) +
  geom_histogram(aes(x=median_beta1996))+
  xlim(c(0,0.6)) +
  ggtitle("Rebounds")
p2=ggplot(data=summary_with_flags %>% filter(rebound_flag==0)) +
  geom_histogram(aes(x=median_beta1996)) +
  xlim(c(0,0.6)) +
  ggtitle("Didn't rebound")
#grid.arrange(p1,p2,nrow=1)
```

# Coverage

- IUs that passed all surveys but had low coverage have high baseline $\beta$ and large reductions in beta by 2020

```{r,message=FALSE,warning=FALSE, out.width="100%"}
corr_drop_cov = sampled_params_all_mutated %>%
  group_by(IU_ID) %>%
  summarise(corr = cor(beta95,eff_cov),
            median_beta95 = median(beta95),
            median_eff_cov = median(eff_cov),
            median_reduction2020 = median(reduction2020)) %>%
  left_join(summary_with_flags %>% select(IU_ID,failed_impact_flag,persistent_flag,failed_surveillance_flag,rebound_flag)) %>%
  mutate(passed_flag = factor(ifelse(rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0,1,0))) 

p0=ggplot(data=corr_drop_cov) +
  geom_histogram(aes(x=corr)) +
  ggtitle("All IUs")

p1=ggplot(data=corr_drop_cov %>% filter(failed_impact_flag==1)) +
  geom_histogram(aes(x=corr)) +
  ggtitle("Failed imp. IUs")

p2=ggplot(data=corr_drop_cov %>% filter(persistent_flag==1)) +
  geom_histogram(aes(x=corr)) +
  ggtitle("Persistent IUs")

p3=ggplot(data=corr_drop_cov %>% filter(failed_surveillance_flag==1)) +
  geom_histogram(aes(x=corr)) +
  ggtitle("Failed surv. IUs")

p4=ggplot(data=corr_drop_cov %>% filter(rebound_flag==1)) +
  geom_histogram(aes(x=corr)) +
  ggtitle("Rebound IUs")

p5=ggplot(data=corr_drop_cov %>% filter(rebound_flag==0 & failed_surveillance_flag==0 & persistent_flag==0 & failed_impact_flag==0)) +
  geom_histogram(aes(x=corr)) +
  ggtitle("Non-flagged IUs")

#grid.arrange(p0,p1,p2,p3,p4,p5,nrow=2)


# raw data 
ggplot(data=corr_drop_cov, aes(x=median_eff_cov,y=median_beta95, col=passed_flag, fill=passed_flag)) +
  geom_point(alpha=0.5) + 
  xlab("median eff_cov") +
  ylab("median beta1996") +
  ggtitle("Median eff_cov vs median baseline beta")


ggplot(data=corr_drop_cov, aes(x=median_eff_cov,y=median_reduction2020, col=passed_flag, fill=passed_flag)) +
  geom_point(alpha=0.5) + 
  xlab("median eff_cov") +
  ylab("median reduction2020") +
  ggtitle("Median eff_cov vs median reduction2020")
```

# Check trajectories for IUs that failed a surveillance survey or rebounded

- Plotting IUs that failed a surveillance survey or rebounded to see if their simulated trajectories are at the top end of the 0-5% TF prevalence band
- For IUs where the rebounded data point wasn't fit, the model still hovers around 5% for most IUs. Although some IUs have some simulations that approach 0%
- When the rebounded data point was fit, none of the IUs reach 0% prevalence

Legend:

- Black points and grey ribbon: median and 95% interval
- Green horizontal line: 5%
- Black horizontal line: 0%

```{r,message=FALSE, fig.dim = c(10, 25), out.width="100%"}
check_traj_q0.5 = sampled_params_all_mutated  %>%
  left_join(summary_with_flags %>% 
              select(IU_ID,failed_surveillance_flag,rebound_flag)) %>%
  filter(rebound_flag==1 | failed_surveillance_flag==1) %>%
              #select(IU_ID,failed_impact_flag,persistent_flag,failed_surveillance_flag,rebound_flag)) %>%
  #filter(rebound_flag==1 | failed_surveillance_flag==1 | persistent_flag==1 | failed_impact_flag==1) %>%
  group_by(IU_ID) %>%
  summarise_at(vars(starts_with("prev")), median) %>%
  melt(variable.name = "Year", value.name = "q0.5") %>%
  mutate(Year=as.numeric(substr(as.character(Year),6,nchar(as.character(Year))))) 


check_traj_q0.025 = sampled_params_all_mutated  %>%
  left_join(summary_with_flags %>% 
              select(IU_ID,failed_surveillance_flag,rebound_flag)) %>%
  filter(rebound_flag==1 | failed_surveillance_flag==1) %>%
              #select(IU_ID,failed_impact_flag,persistent_flag,failed_surveillance_flag,rebound_flag)) %>%
  #filter(rebound_flag==1 | failed_surveillance_flag==1 | persistent_flag==1 | failed_impact_flag==1) %>%
  group_by(IU_ID) %>%
  summarise_at(vars(starts_with("prev")), quantile, na.rm=T,probs=c(0.025)) %>%
  melt(variable.name = "Year", value.name = "q0.025") %>%
  mutate(Year=as.numeric(substr(as.character(Year),6,nchar(as.character(Year)))))


check_traj_q0.975 = sampled_params_all_mutated  %>%
  left_join(summary_with_flags %>% 
              select(IU_ID,failed_surveillance_flag,rebound_flag)) %>%
  filter(rebound_flag==1 | failed_surveillance_flag==1) %>%
              #select(IU_ID,failed_impact_flag,persistent_flag,failed_surveillance_flag,rebound_flag)) %>%
  #filter(rebound_flag==1 | failed_surveillance_flag==1 | persistent_flag==1 | failed_impact_flag==1) %>%
  group_by(IU_ID) %>%
  summarise_at(vars(starts_with("prev")), quantile, na.rm=T,probs=c(0.975)) %>%
  melt(variable.name = "Year", value.name = "q0.975") %>%
  mutate(Year=as.numeric(substr(as.character(Year),6,nchar(as.character(Year)))))

check_traj_all = cbind(check_traj_q0.5,q0.025=check_traj_q0.025[,"q0.025"],q0.975=check_traj_q0.975[,"q0.975"])
check_traj_all[which(check_traj_all$q0.5 == 0),"q0.5"] = 0.000001
check_traj_all[which(check_traj_all$q0.025 == 0),"q0.025"] = 0.000001
check_traj_all[which(check_traj_all$q0.975 == 0),"q0.975"] = 0.000001

check_traj_all_summary = check_traj_all %>%
  group_by(IU_ID) %>%
  summarise(min_tf = min(q0.025,na.rm=T)) %>%
  arrange(min_tf)

rebound_not_fitted = surveys %>%
  filter(max_survey_change==1 & !max_tf_prev_upr==0.05)

print("rebound not fitted")

ggplot(aes(x=Year), 
       data=check_traj_all %>% 
         filter(IU_ID %in% rebound_not_fitted$IU_ID) %>%
         filter(!is.na(q0.5)) %>% 
         mutate(IU_ID = factor(IU_ID,levels=check_traj_all_summary$IU_ID))) +
  geom_ribbon(aes(ymin=q0.025,ymax=q0.975),col="grey",fill="grey",alpha=0.5) +
  geom_point(aes(y=q0.5)) +
  geom_hline(aes(yintercept=0.05),colour="green") +
  geom_hline(aes(yintercept=0.000001),colour="black") +
  ylab("Simulated prevalence (log10 scale)") +
  scale_y_continuous(trans='log10') +
  facet_wrap(~IU_ID,ncol=5)


print("rebound fitted")

ggplot(aes(x=Year), 
       data=check_traj_all %>% 
         filter(!IU_ID %in% rebound_not_fitted$IU_ID) %>%
         filter(!is.na(q0.5)) %>% 
         mutate(IU_ID = factor(IU_ID,levels=check_traj_all_summary$IU_ID))) +
  geom_ribbon(aes(ymin=q0.025,ymax=q0.975),col="grey",fill="grey",alpha=0.5) +
  geom_point(aes(y=q0.5)) +
  geom_hline(aes(yintercept=0.05),colour="green") +
  geom_hline(aes(yintercept=0.000001),colour="black") +
  ylab("Simulated prevalence (log10 scale)") +
  scale_y_continuous(trans='log10') +
  facet_wrap(~IU_ID,ncol=5)

```

